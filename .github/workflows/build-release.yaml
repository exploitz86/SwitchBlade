name: Release Build

on: 
  push:
    tags:
      - 'v*'     # Triggers on version tags like v1.0.0
      - '[0-9]*' # Triggers on version tags like 1.0.0
  workflow_dispatch:  # Manual trigger

permissions:
  contents: write

jobs:
  build-release:
    runs-on: ubuntu-latest
    
    container: devkitpro/devkita64
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Update repo config
        run: |
          git config --global --add safe.directory /__w/SwitchBlade/SwitchBlade/lib/borealis
          git config --global --add safe.directory /__w/SwitchBlade/SwitchBlade
          git config --global --add safe.directory /__w/SwitchBlade/SwitchBlade/TegraExplorer

      - name: Setup environment
        run: |
          export DEVKITPRO=/opt/devkitpro
          export DEVKITA64=/opt/devkitpro/devkitA64
          export LIBNX=/opt/devkitpro/libnx
          export PORTLIBS=/opt/devkitpro/portlibs/switch
          echo "Environment variables set"

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get -y install gcc

      - name: Set xmake env
        run: echo "XMAKE_GLOBALDIR=${{ runner.workspace }}/xmake-global" >> $GITHUB_ENV

      - name: Setup xmake
        uses: xmake-io/github-action-setup-xmake@v1
        with:
          xmake-version: branch@dev

      - name: Update xmake repository
        run: |
          xmake repo --update --root && xmake repo -u --root
          dkp-pacman -Rs --noconfirm switch-tinyxml2 || true

      - name: Install devkitARM for TegraExplorer
        run: |
          dkp-pacman -S --noconfirm devkitARM || true
          echo "DEVKITARM=/opt/devkitpro/devkitARM" >> $GITHUB_ENV

      - name: Configure xmake
        run: xmake f --yes -p cross -m release -a aarch64 --toolchain=devkita64 -vD --root

      - name: Build forwarder
        run: make -C forwarder

      - name: Build TegraExplorer
        run: make -C TegraExplorer

      - name: Build SwitchBlade
        run: xmake -vD --root

      - name: Create release package
        run: |
          mkdir -p release/switch/SwitchBlade
          cp build/cross/aarch64/release/SwitchBlade.nro release/switch/SwitchBlade/
          cd release
          zip -r ../SwitchBlade.zip .
          cd ..
          echo "Release package created:"
          ls -la SwitchBlade.zip
          unzip -l SwitchBlade.zip

      - name: Create Draft Release
        uses: softprops/action-gh-release@v1
        if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')
        with:
          draft: true
          prerelease: false
          name: "SwitchBlade ${{ github.ref_name }}"
          generate_release_notes: true
          files: SwitchBlade.zip
          token: ${{ secrets.GITHUB_TOKEN }}
